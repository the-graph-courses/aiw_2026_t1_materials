<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="The Graph Courses">

<title>Portfolio Website Chatbot with Botpress</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="week_04_workshop_instructions_files/libs/clipboard/clipboard.min.js"></script>
<script src="week_04_workshop_instructions_files/libs/quarto-html/quarto.js"></script>
<script src="week_04_workshop_instructions_files/libs/quarto-html/popper.min.js"></script>
<script src="week_04_workshop_instructions_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="week_04_workshop_instructions_files/libs/quarto-html/anchor.min.js"></script>
<link href="week_04_workshop_instructions_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="week_04_workshop_instructions_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="week_04_workshop_instructions_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="week_04_workshop_instructions_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="week_04_workshop_instructions_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#part-1-setting-up-your-botpress-account-and-creating-your-bot" id="toc-part-1-setting-up-your-botpress-account-and-creating-your-bot" class="nav-link" data-scroll-target="#part-1-setting-up-your-botpress-account-and-creating-your-bot">Part 1: Setting Up Your Botpress Account and Creating Your Bot</a></li>
  <li><a href="#part-2-setting-up-the-bot-instructions" id="toc-part-2-setting-up-the-bot-instructions" class="nav-link" data-scroll-target="#part-2-setting-up-the-bot-instructions">Part 2: Setting Up the Bot Instructions</a></li>
  <li><a href="#part-3-set-up-the-knowledge-base" id="toc-part-3-set-up-the-knowledge-base" class="nav-link" data-scroll-target="#part-3-set-up-the-knowledge-base">Part 3: Set up the Knowledge Base</a></li>
  <li><a href="#part-4-set-up-data-collection" id="toc-part-4-set-up-data-collection" class="nav-link" data-scroll-target="#part-4-set-up-data-collection">Part 4: Set Up Data Collection</a></li>
  <li><a href="#part-5-testing-and-publishing-your-bot" id="toc-part-5-testing-and-publishing-your-bot" class="nav-link" data-scroll-target="#part-5-testing-and-publishing-your-bot">Part 5: Testing and Publishing Your Bot</a></li>
  <li><a href="#part-6-embedding-your-bot-on-your-website" id="toc-part-6-embedding-your-bot-on-your-website" class="nav-link" data-scroll-target="#part-6-embedding-your-bot-on-your-website">Part 6: Embedding Your Bot on Your Website</a>
  <ul class="collapse">
  <li><a href="#part-6a-add-bot-to-your-portfolio" id="toc-part-6a-add-bot-to-your-portfolio" class="nav-link" data-scroll-target="#part-6a-add-bot-to-your-portfolio">Part 6A: Add Bot to Your Portfolio</a></li>
  <li><a href="#part-6b-test-live-integration" id="toc-part-6b-test-live-integration" class="nav-link" data-scroll-target="#part-6b-test-live-integration">Part 6B: Test Live Integration</a></li>
  </ul></li>
  <li><a href="#part-8-submission" id="toc-part-8-submission" class="nav-link" data-scroll-target="#part-8-submission">Part 8: Submission</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Portfolio Website Chatbot with Botpress</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>The Graph Courses </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Welcome! In this assignment, you’ll create an LLM-powered chatbot using Botpress and embed it into your portfolio website that you created in a previous session.</p>
<p>Your completed chatbot will be able to:</p>
<ol type="1">
<li><strong>Answer CV/Resume Questions</strong> - Provide information about your background using uploaded CV data</li>
<li><strong>Share Course Information</strong> - Provide info about the Graph Courses GenAI syllabus and curriculum details<br>
</li>
<li><strong>Collect Visitor Information</strong> - Gather names and emails from interested visitors for showcase day registration</li>
</ol>
<hr>
</section>
<section id="part-1-setting-up-your-botpress-account-and-creating-your-bot" class="level1">
<h1>Part 1: Setting Up Your Botpress Account and Creating Your Bot</h1>
<p>Our first task is to set up a Botpress account and create a new bot.</p>
<p>Note that Botpress interface changes from time to time, so the screenshots may not be exactly the same as the ones in the instructions.</p>
<p>Also note that the free account will allow your chatbots to send/receive up to 500 messages. This should be enough for our course chatbots. But for serious use later on, you may need to add credit to your account)</p>
<ol type="1">
<li><p><strong>Create Your Botpress Account:</strong></p>
<ul>
<li><p>Go to <a href="https://botpress.com/">botpress.com</a></p></li>
<li><p>Sign up for a free account using your email.</p></li>
<li><p>Verify your email address if needed. (Botpress will send you a verification email to your inbox.)</p></li>
<li><p>When you first sign up, you may be taken to a screen like the below asking whether you want to “build with AI” or let the Botpress team build for you. Select “build with AI”.</p>
<p><img src="images/build_with_ai.jpg" class="img-fluid" width="331"></p></li>
<li><p>You will then see a “Setup” screen. This is not needed. We will set up our bot from scratch. Click on “Skip” at the top right.</p></li>
</ul>
<p><img src="images/skip_setup.jpg" class="img-fluid" width="536"></p></li>
<li><p><strong>Open the Bot Studio:</strong></p>
<ul>
<li>You will now be brought to your bot’s homepage. To open the bot studio, click on the “Edit in Studio” button at the top right.</li>
</ul>
<p><img src="images/edit_in_studio.jpg" class="img-fluid" width="545"></p>
<ul>
<li>At this point, botpress may try to get you to sign up for a paid plan. Ignore this either by pressing Escape on the keyboard, or by clicking outside of the pop-up.</li>
</ul></li>
</ol>
</section>
<section id="part-2-setting-up-the-bot-instructions" class="level1">
<h1>Part 2: Setting Up the Bot Instructions</h1>
<p>You now need to give an agent prompt that the LLM will use as context to understand how it should behave.</p>
<ol type="1">
<li><p><strong>Set Bot Instructions:</strong></p>
<ul>
<li>In the main configuration area, find the “Instructions” field</li>
</ul>
<p><img src="images/bot_instructions.jpg" class="img-fluid"></p>
<ul>
<li>Enter instructions like the below:</li>
</ul></li>
</ol>
<pre class="{text}"><code>You are a portfolio assistant for a Generative AI course student. Your main tasks are:

- Answer questions about the student's CV and background using the knowledge base
- Provide information about the Graph Courses GenAI syllabus and curriculum based on your knowledge base
- After answering the user's query, politely ask them whether they might be interested in our upcoming showcase event. These take place on 

-  Sunday, November 30, 5pm GMT
-  Wednesday, December 3, 3pm GMT

- If they express interest, collect their name and email for registration and record those in the Attendees table tool.
- Try to be helpful while staying focused on these core topics. For other topics, politely decline to answer. </code></pre>
</section>
<section id="part-3-set-up-the-knowledge-base" class="level1">
<h1>Part 3: Set up the Knowledge Base</h1>
<p>Our next task is to set up a knowledge base for the bot to use to answer questions. As long as the knowledge we provide is not too long (not over the LLM’s context window limit), the bot will be able to use it proficiently to answer questions.</p>
<ol type="1">
<li><strong>Navigate to Knowledge Base:</strong>
<ul>
<li>Find the “Knowledge Base” section under the “Instructions” section</li>
<li>Drag and drop your CV into the upload box. (If you don’t want any of your personal information online, you can use a fake example CV from the internet, like here: <a href="https://www.careers.ox.ac.uk/files/traditional-cv-examplepdf" class="uri">https://www.careers.ox.ac.uk/files/traditional-cv-examplepdf</a>)</li>
<li>Download the syllabus from: <a href="https://drive.google.com/file/d/1NV-Mo2UgXQwdTu_Jv-HtCVnB9Pf2Grng/view" class="uri">https://drive.google.com/file/d/1NV-Mo2UgXQwdTu_Jv-HtCVnB9Pf2Grng/view</a>, and upload it to the knowledge base.</li>
</ul></li>
</ol>
</section>
<section id="part-4-set-up-data-collection" class="level1">
<h1>Part 4: Set Up Data Collection</h1>
<p>Next, we will create a table to store the data of the attendees of the showcase event.</p>
<ol type="1">
<li><p><strong>Create Attendees Table Structure:</strong></p>
<ul>
<li>On the Botpress sidebar, click on the Tables icon.</li>
</ul>
<p><img src="images/tables_icon.jpg" class="img-fluid"></p>
<ul>
<li>Click on the New Table button at the top left and call it something like “Attendees”, then click to Save.</li>
</ul>
<p><img src="images/new_table.jpg" class="img-fluid" width="346"></p>
<ul>
<li>Click the new column icon to add the following two columns, leaving all settings as default
<ul>
<li>Name</li>
<li>Email</li>
</ul></li>
</ul>
<p><img src="images/new_column_icon.jpg" class="img-fluid"></p></li>
<li><p><strong>Configure Collection:</strong></p></li>
</ol>
<p>Now, we have created the table, we need to tell the bot when and how to use this tool to store data.</p>
<ul>
<li>Return to the main configuration area, by clicking on the “Main” icon on the left sidebar</li>
</ul>
<p><img src="images/main_icon.jpg" class="img-fluid"></p>
<ul>
<li>Scroll down to the Tools section</li>
</ul>
<p><img src="images/tools_section.jpg" class="img-fluid" width="436"></p>
<ul>
<li>Click on Tables then the Attendees table, then “Create Rows”. This gives your bot the ability to create rows in that table.</li>
</ul>
<p><img src="images/table_tool.jpg" class="img-fluid" width="468"></p>
</section>
<section id="part-5-testing-and-publishing-your-bot" class="level1">
<h1>Part 5: Testing and Publishing Your Bot</h1>
<ol type="1">
<li><p><strong>Use the Test Chat:</strong></p>
<ul>
<li>The Botpress interface has a test chat panel on the right side of the screen</li>
<li>Try asking questions about:
<ul>
<li>Your background (“Tell me about the educational background of [your name]”)</li>
<li>Course content (“What topics are covered in the GenAI course?”)</li>
</ul></li>
<li>The bot should interrupt at some point to ask if you might be interested in the event.</li>
<li>Give your email and name, then check the Attendees table to see if the bot was successful in adding your information.</li>
</ul></li>
<li><p><strong>Publish:</strong></p>
<ul>
<li>Click “Publish” button in the top-right corner</li>
<li>Wait for the publishing process to complete</li>
</ul></li>
<li><p><strong>Get Embedding Code:</strong></p>
<ul>
<li>After publishing, click on the “Chat Bubble” icon under the Publish menu.</li>
<li>You’ll be taken to a section where you can edit the chat bubble settings.</li>
<li>Next, navigate to the “Share” menu and copy the code under “Embed Code”</li>
</ul>
<p><img src="images/embed_code.jpg" class="img-fluid" width="613"></p></li>
</ol>
</section>
<section id="part-6-embedding-your-bot-on-your-website" class="level1">
<h1>Part 6: Embedding Your Bot on Your Website</h1>
<p>Now, we need to add this code to your portfolio website, so that a chat bubble appears at the bottom right of the page.</p>
<section id="part-6a-add-bot-to-your-portfolio" class="level2">
<h2 class="anchored" data-anchor-id="part-6a-add-bot-to-your-portfolio">Part 6A: Add Bot to Your Portfolio</h2>
<ol type="1">
<li><strong>Access Your GitHub Repository:</strong>
<ul>
<li>Go to your GitHub Pages repository where your portfolio is hosted</li>
<li>Open the <code>index.html</code> file for editing</li>
</ul></li>
<li><strong>Insert the Bot Code:</strong>
<ul>
<li><p>Next, add the Webchat embed code to the head section of your website’s HTML. For example:</p>
<p><img src="images/head_section.jpg" class="img-fluid" width="456"></p></li>
<li><p>If you do not feel comfortable making this change yourself, you can ask an LLM to do it for you.</p></li>
</ul></li>
<li><strong>Commit and Deploy:</strong>
<ul>
<li>Save your changes to the <code>index.html</code> file</li>
<li>Commit the changes to your GitHub repository</li>
<li>Your live site will update automatically (this may take 3-5 minutes)</li>
<li>You can track the status of your deployment by clicking on the “Actions” tab in the menu of the GitHub repository page</li>
<li>NOTE: Even after the site is done deploying, you may need to refresh the page a few times to see the bot appear, because your browser may be loading a cached version of the page.</li>
</ul></li>
</ol>
</section>
<section id="part-6b-test-live-integration" class="level2">
<h2 class="anchored" data-anchor-id="part-6b-test-live-integration">Part 6B: Test Live Integration</h2>
<ol type="1">
<li><strong>Visit Your Live Site:</strong>
<ul>
<li>Go to your GitHub Pages URL</li>
<li>Look for the chat bubble (usually appears in the bottom-right corner)</li>
</ul></li>
<li><strong>Test Full Functionality:</strong>
<ul>
<li>Try the same tests you did before, but now on your live website</li>
<li>Ensure the bot loads properly and responds correctly</li>
<li>Verify the registration flow works in the live environment</li>
</ul></li>
<li><strong>Making changes to your bot:</strong>
<ul>
<li>WATCH OUT: If you make any changes to your bot, be sure to click on “Publish” again in the top-right corner to save your changes.</li>
</ul></li>
</ol>
</section>
</section>
<section id="part-8-submission" class="level1">
<h1>Part 8: Submission</h1>
<p>To submit:</p>
<ul>
<li>Upload a screenshot of your chatbot ‘in action’ on the graph courses website in the upload box.</li>
<li>Paste a link to your website in the comments section.</li>
</ul>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>